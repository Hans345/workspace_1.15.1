#include <stdint.h>
#include <stdbool.h>
#include <stddef.h>
#include "driverlib/eeprom.h"
#include "hal.h"
#include "memorymap.h"
#include "task_handler.h"



uint8_t handler_state, prev_handler_state;
uint32_t handler_timeout;
uint32_t cycle_counter;
CONFIG_MEMORY config;

//-----------------------------------------------------------------------------------------------------------------------

void enter_handler_state(uint8_t state)
{
    switch(state){
    //--------------------------------------------------------------------------------------
        case IDLE:
        break;
    //--------------------------------------------------------------------------------------
        case INIT:
            setCurrentLimit(config.CurrentLimit);
            setPWMFreqency(config.PWMfreqency);
            set_handler_timeout(100); // 100ms startup delay for CurrentLimit reference Voltage t = 4.7k * 10uF ~ 47ms
        break;
    //--------------------------------------------------------------------------------------
        case START:
            cycle_counter = 0;
        break;
    //--------------------------------------------------------------------------------------
        case TON:
            set_handler_timeout(config.onTime);
            setPWM4PulseWidth(config.PWM4PW);
            setPWM5PulseWidth(config.PWM5PW);
        break;
    //--------------------------------------------------------------------------------------
        case TOFF:
            set_handler_timeout(config.offTime);
            halDisPWM();
        break;
    //--------------------------------------------------------------------------------------
        case LOOP:
            cycle_counter++;
        break;
    //--------------------------------------------------------------------------------------
        default:
        break;
    //--------------------------------------------------------------------------------------
    }
}

//-----------------------------------------------------------------------------------------------------------------------

void exec_handler_state(uint8_t state)
{
    switch(state){
    //--------------------------------------------------------------------------------------
        case IDLE:
        break;
    //--------------------------------------------------------------------------------------
        case INIT:
            if(!handler_timeout){
                set_handler_state(START);
            }
        break;
    //--------------------------------------------------------------------------------------
        case START:
            set_handler_state(TON);
        break;
    //--------------------------------------------------------------------------------------
        case TON:
            if(!handler_timeout){
                set_handler_state(TOFF);
            }
        break;
    //--------------------------------------------------------------------------------------
        case TOFF:
            if(!handler_timeout){
                set_handler_state(LOOP);
            }
        break;
    //--------------------------------------------------------------------------------------
        case LOOP:
            if(cycle_counter < ((config.ProcessTime * 1000) / (config.onTime + config.offTime))){
                set_handler_state(TON);
            }else{
                set_handler_state(IDLE);
            }
      break;
      //--------------------------------------------------------------------------------------
      default:
      break;
      //--------------------------------------------------------------------------------------
    }
}

//-----------------------------------------------------------------------------------------------------------------------

void leave_handler_state(uint8_t state)
{
    switch(state){
    //--------------------------------------------------------------------------------------
        case IDLE:
        break;
    //--------------------------------------------------------------------------------------
        case INIT:
        break;
    //--------------------------------------------------------------------------------------
        case START:
        break;
    //--------------------------------------------------------------------------------------
        case TON:
        break;
    //--------------------------------------------------------------------------------------
        case TOFF:
        break;
    //--------------------------------------------------------------------------------------
        case LOOP:
        break;
    //--------------------------------------------------------------------------------------
        default:
        break;
    //--------------------------------------------------------------------------------------
    }
}

//-----------------------------------------------------------------------------------------------------------------------

void handler_rt_task(void)
{
    if(handler_timeout > 0){
        handler_timeout--;
    }
}

void handler_task(void)
{
    exec_handler_state(handler_state);
}

void set_handler_state(uint8_t state)
{
    prev_handler_state = handler_state;
    handler_state = state;
    leave_handler_state(prev_handler_state);
    enter_handler_state(state);
}

uint8_t get_handler_state(void)
{
    return handler_state;
}


void set_handler_timeout(uint32_t timeout)
{
    handler_timeout = timeout;
}

