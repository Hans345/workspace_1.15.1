#include "task_handler.h"


//-----------------------------------------------------------------------------------------------------------------------
/****** VARIABLES ******/
static uint16_t time_val = 0;
static uint8_t handler_state;
static uint8_t prev_handler_state;

void enter_handler_state(uint8_t state)
{
    switch(state){
    //--------------------------------------------------------------------------------------
        case IDLE:

        break;
    //--------------------------------------------------------------------------------------
        case LEDON:
			/****** LED2 ******/
        	HAL_GPIO_WritePin(LD2, LD2_PIN, GPIO_PIN_SET);
        break;
    //--------------------------------------------------------------------------------------
        case LEDBLINK:

        break;
    //--------------------------------------------------------------------------------------
        default:
        break;
    //--------------------------------------------------------------------------------------
    }
}

//-----------------------------------------------------------------------------------------------------------------------

void exec_handler_state(uint8_t state)
{
    switch(state){
    //--------------------------------------------------------------------------------------
        case IDLE:

        break;
    //--------------------------------------------------------------------------------------
        case LEDON:
        	// LEDON -> IDLE
			if(HAL_GPIO_ReadPin(B1, B1_PIN) && time_val > 1000)
			{
				set_handler_state(IDLE);
			}
        break;
    //--------------------------------------------------------------------------------------
        case LEDBLINK:
        	// LEDON -> IDLE
			if(HAL_GPIO_ReadPin(B1, B1_PIN) && time_val > 1000)
			{
				set_handler_state(IDLE);
			}
			else if (time_val > 1000)
			{
				HAL_GPIO_TogglePin(LD2, LD2_PIN);
				time_val = 0;
			}
        break;
      //--------------------------------------------------------------------------------------
      default:
      break;
      //--------------------------------------------------------------------------------------
    }
}

//-----------------------------------------------------------------------------------------------------------------------

void leave_handler_state(uint8_t state)
{
    switch(state){
    //--------------------------------------------------------------------------------------
        case IDLE:
        break;
    //--------------------------------------------------------------------------------------
        case LEDON:
        break;
    //--------------------------------------------------------------------------------------
        case LEDBLINK:
        break;
    //--------------------------------------------------------------------------------------
        default:
        break;
    //--------------------------------------------------------------------------------------
    }
}

//-----------------------------------------------------------------------------------------------------------------------

void handler_task(void)
{
    exec_handler_state(handler_state);
}

void set_handler_state(uint8_t state)
{
    prev_handler_state = handler_state;
    handler_state = state;
    leave_handler_state(prev_handler_state);
    enter_handler_state(state);
}

void increase_handler_state(void)
{
	if(handler_state < LEDON)
	{
	    prev_handler_state = handler_state;
	    handler_state = handler_state++;
	    leave_handler_state(prev_handler_state);
	    enter_handler_state(state);
	}
}

uint8_t get_handler_state(void)
{
    return handler_state;
}


void set_handler_currentTime(uint16_t dT)
{
    time_val = time_val + dT;
}

void reset_handler_currentTime(void)
{
    time_val = 0;
}

